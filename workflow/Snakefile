REFERENCE_FASTA_PATH = dict(
    CHM13="/home/miaocj/docker_dir/data/reference_genome/CHM13/chm13v2.0.fa.gz",
)
REGIONS = dict(
    TRA=("chr14", 14819498, 17749884),
    HLA=("chr6", 28476949, 34231258),
    IGK=("chr2", 87866370, 91790947),
    IGH=("chr14", 98839469, 101161492),
    chr6_50M=("chr6", 0, 50_000_000),
    chr1_248M=("chr1", 0, 1_000_000_000)
)



wildcard_constraints:
    length_kb=r"\d+",
    sample=r"\w+",
    region=r"\w+",
    platform=r"\w+",
    encoding=r"\w+",


rule extract_regional_reference:
    input:
        fasta=lambda wildcards: REFERENCE_FASTA_PATH[wildcards["sample"]],
    output:
        fasta="data/regional_reference/{sample}/{region}/reference.fasta.gz",
    params:
        region=lambda wildcards: REGIONS[wildcards["region"]],
    conda:
        "envs/default.yaml"
    script:
        "scripts/extract_regional_reference.smk.py"


rule simulate_perfect_sequencing_reads:
    input:
        fasta="data/regional_reference/{sample}/{region}/reference.fasta.gz",
    output:
        fasta="data/regional_reads/{sample}/{region}/perfect_{length_kb}k/reads.fasta.gz",
    params:
        length_kb=lambda wildcards: int(wildcards["length_kb"]),
        depth=30,
        seed=3558929,
    wildcard_constraints:
        length_kb=r"\d+",
    conda:
        "envs/default.yaml"
    script:
        "scripts/simulate_perfect_sequencing_reads.smk.py"


rule run_pbsim3_ont:
    input:
        reference="data/regional_reference/{sample}/{region}/reference.fasta.gz",
        model="resources/pbsim/ERRHMM-ONT-HQ.model",
    output:
        folder=directory(
            "data/regional_reads/{sample}/{region}/pbsim_ONT_{accuracy}_{length_kb}k"
        ),
        fasta="data/regional_reads/{sample}/{region}/pbsim_ONT_{accuracy}_{length_kb}k/reads.fasta.gz",
        maf="data/regional_reads/{sample}/{region}/pbsim_ONT_{accuracy}_{length_kb}k/alignment.maf.gz",
    wildcard_constraints:
        accuracy=r"\d+",
        length_kb=r"\d+",
    params:
        accuracy=lambda wildcards: float(wildcards["accuracy"]) / 100,
        length_mean=lambda wildcards: int(wildcards["length_kb"]) * 1000,
        length_sd=lambda wildcards: int(wildcards["length_kb"]) * 500,
        length_min=10_000,
        depth=20,
        seed=5023967,
    conda:
        "envs/pbsim.yaml"
    shell:
        """
        gunzip -c {input.reference} \
        | pbsim \
            --strategy wgs \
            --method errhmm \
            --errhmm {input.model} \
            --depth {params.depth} \
            --accuracy-mean {params.accuracy} \
            --length-mean {params.length_mean} \
            --length-sd  {params.length_sd} \
            --length-min {params.length_min} \
            --genome /dev/stdin \
            --seed {params.seed} \
            --prefix {output.folder}/output
        sed -n '1~4s/^@/>/p;2~4p' {output.folder}/output_0001.fastq | gzip -c > {output.fasta}
        gzip -c {output.folder}/output_0001.maf > {output.maf}
        rm -rf {output.folder}/output*
        """

rule run_pbsim3_pb_hifi:
    input:
        reference="data/regional_reference/{sample}/{region}/reference.fasta.gz",
        model="resources/pbsim/ERRHMM-SEQUEL.model",
    output:
        folder=directory(
            "data/regional_reads/{sample}/{region}/pbsim_pb_hifi_{length_kb}k"
        ),
        fasta="data/regional_reads/{sample}/{region}/pbsim_pb_hifi_{length_kb}k/reads.fasta.gz",
        maf="data/regional_reads/{sample}/{region}/pbsim_pb_hifi_{length_kb}k/alignment.maf.gz",
    params:
        length_mean=lambda wildcards: int(wildcards["length_kb"]) * 1000,
        pass_num=10,
        depth=20,
        seed=5023967,
    conda:
        "envs/pbsim.yaml"
    shell:
        """
        gunzip -c {input.reference} \
        | pbsim \
            --strategy wgs \
            --method errhmm \
            --errhmm {input.model} \
            --depth {params.depth} \
            --length-mean {params.length_mean} \
            --pass-num {params.pass_num} \
            --genome /dev/stdin \
            --seed {params.seed} \
            --prefix {output.folder}/output
        samtools sort -@ 10  {output.folder}/output_0001.sam -o  {output.folder}/output_0001.bam
        ccs  -j 10 {output.folder}/output_0001.bam  {output.folder}/output_hifi.fastq.gz
        gunzip -c {output.folder}/output_hifi.fastq.gz | sed -n '1~4s/^@/>/p;2~4p' | gzip -c > {output.fasta}
        gzip -c {output.folder}/output_0001.maf > {output.maf}
        rm -rf {output.folder}/output*
        """

rule get_perfect_read_info:
    input:
        fasta="data/regional_reads/{sample}/{region}/{platform}/reads.fasta.gz",
    output:
        tsv="data/regional_reads/{sample}/{region}/{platform}/read_info.tsv.gz",
    wildcard_constraints:
        platform=r"perfect_.+",
    conda:
        "envs/default.yaml"
    script:
        "scripts/get_perfect_read_info.smk.py"


rule get_pbsim_ONT_metadata:
    input:
        maf="data/regional_reads/{sample}/{region}/{platform}/alignment.maf.gz",
    output:
        tsv="data/regional_reads/{sample}/{region}/{platform}/read_info.tsv.gz",
    wildcard_constraints:
        platform=r"pbsim_ONT.+",
    conda:
        "envs/default.yaml"
    script:
        "scripts/get_pbsim_read_info.smk.py"

rule get_pbsim_pb_ccs_metadata:
    input:
        maf="data/regional_reads/{sample}/{region}/{platform}/alignment.maf.gz",
        fasta="data/regional_reads/{sample}/{region}/{platform}/reads.fasta.gz",
    output:
        tsv="data/regional_reads/{sample}/{region}/{platform}/read_info.tsv.gz",
    wildcard_constraints:
        platform=r"pbsim_pb.+",
    conda:
        "envs/default.yaml"
    script:
        "scripts/get_pbsim_read_info_hifi.smk.py"

rule kmer_encoding:
    input:
        fasta="data/regional_reads/{sample}/{region}/{platform}/reads.fasta.gz",
        tsv="data/regional_reads/{sample}/{region}/{platform}/read_info.tsv.gz",
    output:
        npz="data/feature_matrix/{sample}/{region}/{platform}/kmer_k{k}/feature_matrix.npz",
        json="data/feature_matrix/{sample}/{region}/{platform}/kmer_k{k}/read_features.json.gz",
        tsv="data/feature_matrix/{sample}/{region}/{platform}/kmer_k{k}/metadata.tsv.gz",
    params:
        sample_fraction=0.05,
        min_multiplicity=2,
        seed=562104830,
    wildcard_constraints:
        k=r"\d+",
        platform=r"pbsim_.+",
    conda:
        "envs/default.yaml"
    script:
        "scripts/kmer_encoding_for_sim.smk.py"

#-----------------------------------up for simulate data------------------------------------------------

rule paf_to_read_info:
    input:
        fasta_aligned="data/regional_reads/{sample}/{region}/{platform}/aligned_read.fa.gz",
        paf="data/regional_reads/{sample}/{region}/{platform}/alignment.paf.gz",
    output:
        tsv="data/regional_reads/{sample}/{region}/{platform}/read_info.tsv.gz",
        stat="data/regional_reads/{sample}/{region}/{platform}/read_usage_statistic.tsv.gz",
        fasta="data/regional_reads/{sample}/{region}/{platform}/reads.fasta.gz",
    conda:
        "envs/default.yaml"
    script:
        "scripts/get_real_read_info.smk.py"

rule kmer_encoding_from_paf:
    input:
        fasta="data/regional_reads/{sample}/{region}/{platform}/reads.fasta.gz",
        tsv="data/regional_reads/{sample}/{region}/{platform}/read_info.tsv.gz",
        paf="data/regional_reads/{sample}/{region}/{platform}/alignment.paf.gz",
    output:
        npz="data/feature_matrix/{sample}/{region}/{platform}/kmer_k{k}/feature_matrix.npz",
        json="data/feature_matrix/{sample}/{region}/{platform}/kmer_k{k}/read_features.json.gz",
        tsv="data/feature_matrix/{sample}/{region}/{platform}/kmer_k{k}/metadata.tsv.gz",
    params:
        sample_fraction=0.05,
        min_multiplicity=2,
        seed=562104830,
    wildcard_constraints:
        k=r"\d+",
    conda:
        "envs/default.yaml"
    script:
        "scripts/kmer_encoding.smk.py"

#--------------------up for real data--------------------------------------------------------


##
rule run_minimap2_ava:
    input:
        fasta="data/regional_reads/{sample}/{region}/{platform}/reads.fasta.gz",
    output:
        paf_minimap2="data/minimap2/{sample}/{region}/{platform}/alignment.paf.gz",
    params:
        preset="ava-ont",
    benchmark:
        "data/evaluation/minimap2/{sample}/{region}/{platform}/minimap2_benchmark.csv"
    conda:
        "envs/minimap2.yaml"
    threads: 120
    shell:
        """
        minimap2 -x {params.preset} -t {threads} {input.fasta} {input.fasta}| gzip -c > {output.paf_minimap2}
        """

rule run_daligner:
    input:
        fasta="data/regional_reads/{sample}/{region}/{platform}/reads.fasta.gz",
    output:
        maf="data/daligner/{sample}/{region}/{platform}/alignment.maf.gz",
    params:
        k = 16,
        average_correlation=".9",
        min_alignment_length=1000,
        min_alignment_score=50,
    threads: 8
    conda:
        "envs/daligner.yaml"
    shell:
        """
        daligner \
            -k{params.k} \
            -e{params.average_correlation} \
            -l{params.min_alignment_length} \
            -s{params.min_alignment_score} \
            -T{threads} \
            -v \
            {input.fasta} {input.fasta} \
        | gzip -c > {output.maf}
        """

rule get_neighbors:
    input:
        feature_matrix="data/feature_matrix/{sample}/{region}/{platform}/{encoding}/feature_matrix.npz",
        read_features="data/feature_matrix/{sample}/{region}/{platform}/{encoding}/read_features.json.gz",
        metadata="data/feature_matrix/{sample}/{region}/{platform}/{encoding}/metadata.tsv.gz",
        paf_minimap2="data/minimap2/{sample}/{region}/{platform}/alignment.paf.gz",
        #paf_blend="data/blend/{sample}/{region}/{platform}/alignment.paf.gz",
    output:
        nbr_indice="data/evaluation/{sample}/{region}/{platform}/{encoding}/{method}_nbr_matrix.npz",
    benchmark:
        "data/evaluation/{sample}/{region}/{platform}/{encoding}/{method}_benchmark.csv"
    log:
        notebook="data/evaluation/{sample}/{region}/{platform}/{encoding}/{method}_get_neighbors.py.ipynb",
    threads: 1
    conda:
        "envs/evaluate.yaml"
    notebook:
        "notebooks/get_neighbors_indice.smk.py.ipynb"


rule evaluate_configs:
    input:
        feature_matrix="data/feature_matrix/{sample}/{region}/{platform}/{encoding}/feature_matrix.npz",
        read_features="data/feature_matrix/{sample}/{region}/{platform}/{encoding}/read_features.json.gz",
        metadata="data/feature_matrix/{sample}/{region}/{platform}/{encoding}/metadata.tsv.gz",
        nbr_indice="data/evaluation/{sample}/{region}/{platform}/{encoding}/{method}_nbr_matrix.npz",
    output:
        overlap="data/evaluation/{sample}/{region}/{platform}/{encoding}/{method}_overlap_stat.tsv",
    log:
        notebook="data/evaluation/{sample}/{region}/{platform}/{encoding}/{method}_evaluate_configs.py.ipynb",
    threads: 8
    conda:
        "envs/evaluate.yaml"
    notebook:
        "notebooks/evaluate_configs.smk.py.ipynb"


rule evaluate_and_visualize_configs:
    input:
        feature_matrix="data/feature_matrix/{sample}/{region}/{platform}/{encoding}/feature_matrix.npz",
        read_features="data/feature_matrix/{sample}/{region}/{platform}/{encoding}/read_features.json.gz",
        metadata="data/feature_matrix/{sample}/{region}/{platform}/{encoding}/metadata.tsv.gz",
        nbr_indice="data/evaluation/{sample}/{region}/{platform}/{encoding}/{method}_nbr_matrix.npz",

    output:
        overlap="data/evaluation/{sample}/{region}/{platform}/{encoding}/{method}_withfig_overlap_stat.tsv",
        fig="data/evaluation/{sample}/{region}/{platform}/{encoding}/{method}_fig.png",
    log:
        notebook="data/evaluation/{sample}/{region}/{platform}/{encoding}/{method}_evaluate_configs.py.ipynb",
    threads: 8
    conda:
        "envs/evaluate.yaml"
    notebook:
        "notebooks/evaluate_configs_visulization.smk.ipynb"


# ----------------------------------------------------------------------------------------------------

rule article_test_ont:
    input:
        expand("data/evaluation/TAIR/chr3/pbsim_pb_hifi_10k/kmer_k16/{method}_overlap_stat.tsv",
        method=[
            'WeightedMinHash_Jaccard_None_TF',
            'WeightedMinHash_Jaccard_None_IDF',
            'WeightedMinHash_Jaccard_None_TF-IDF',
            'MinHash_Jaccard_None_None',
            'Exact_Euclidean_None_None',
            'Exact_Euclidean_None_TF',
            'Exact_Euclidean_None_IDF',
            'Exact_Euclidean_None_TF-IDF',
            'Exact_Cosine_None_None',
            'Exact_Cosine_None_TF',
            'Exact_Cosine_None_IDF',
            'Exact_Cosine_None_TF-IDF',
            'HNSW_Cosine_None_None',
            'HNSW_Euclidean_None_None',##add pre-process if fesible
            'HNSW_Cosine_scBiMap_500d_None',
            'HNSW_Cosine_scBiMap_500d_TF',
            'HNSW_Cosine_scBiMap_500d_IDF',
            'HNSW_Cosine_scBiMap_500d_TF-IDF',
            'HNSW_Euclidean_scBiMap_500d_None',
            'HNSW_Euclidean_scBiMap_500d_TF',
            'HNSW_Euclidean_scBiMap_500d_IDF',
            'HNSW_Euclidean_scBiMap_500d_TF-IDF',
            'Minimap2',
            'HNSW_Cosine_Spectural_500d_None',
            'HNSW_Cosine_Spectural_500d_TF',
            'HNSW_Cosine_Spectural_500d_IDF',
            'HNSW_Cosine_Spectural_500d_TF-IDF',
            'HNSW_Euclidean_Spectural_500d_None',
            'HNSW_Euclidean_Spectural_500d_TF',
            'HNSW_Euclidean_Spectural_500d_IDF',
            'HNSW_Euclidean_Spectural_500d_TF-IDF',
        ])

rule tmp1:
    input:
        expand("data/evaluation/TAIR/chr3/pbsim_ONT_93_30k/kmer_k16/{method}_overlap_stat.tsv",
        method=[
            'SimHash_Cosine_None_TF',
            'SimHash_Cosine_None_IDF',
            'SimHash_Cosine_None_TF-IDF',
            'SimHash_Cosine_None_None',
        ])


rule only_statistic:
    input:
        expand("data/evaluation/human/{region}/ONT_R9/kmer_k16/SimHash_Cosine_None_None_overlap_stat.tsv",
        region=['chr22'])
rule only_statistic1:
    input:
        expand("data/evaluation/human/chr22/ONT_R9/kmer_k16/{method}_overlap_stat.tsv",
        method=[
            'HNSW_Cosine_scBiMap_500d_None',
            'PQ_Cosine_scBiMap_500d_None',
        ])
rule statistic_and_visulization:
    input:
        expand("data/evaluation/Ecoli/all/ONT/kmer_k16/{method}_fig.png",
        method=[
        'HNSW_Euclidean_scBiMap_500d_TF-IDF',
        'WeightedLowHash_Jaccard_None_TF-IDF',
        'WeightedMinHash_Jaccard_None_TF-IDF',
        'NNDescent_Euclidean_scBiMap_500d_TF-IDF',
        ])

rule mytest:
    input:
        expand("data/evaluation/CHM13/{region}/pbsim_ONT_93_30k/kmer_k16/{method}_overlap_stat.tsv",
        region = ['IGH','TRA'],
        method=[
        'Exact_Euclidean_None_None',
        'Exact_Euclidean_scBiMap_500d_None',
        'Exact_Cosine_None_None',
        'Exact_Cosine_scBiMap_500d_None',
        'HNSW_Cosine_scBiMap_500d_None',
        'PQ_Cosine_scBiMap_500d_None',
        'Minimap2',
        'MinHash_Jaccard_None_None',
        'WeightedMinHash_Jaccard_None_None'
        ])
rule mytest2:
    input:
        expand("data/evaluation/Ecoli/all/ONT/kmer_k16/{method}_overlap_stat.tsv",
        method=[
        'Exact_Euclidean_None_None',
        'Exact_Euclidean_scBiMap_500d_None',
        'Exact_Cosine_None_None', 
        'Exact_Cosine_scBiMap_500d_None',
        'HNSW_Cosine_scBiMap_500d_None',
        'PQ_Cosine_scBiMap_500d_None',
        'Minimap2',
        'MinHash_Jaccard_None_None',
        'WeightedMinHash_Jaccard_None_None'
        ])

rule only_statistic2:
    input:
        expand("data/evaluation/human/IGH/ONT_R9/kmer_k16/{method}_overlap_stat.tsv",
        method=[
            'Exact_Euclidean_scBiMap_500d_None',
            'Exact_Euclidean_None_None',
            'Exact_Cosine_None_None',
            'Exact_Cosine_scBiMap_500d_None',
            'HNSW_Cosine_scBiMap_500d_None',
            'PQ_Cosine_scBiMap_500d_None',
            'Minimap2',
            'MinHash_Jaccard_None_None',
            'WeightedMinHash_Jaccard_None_None',
            'Exact_Euclidean_scBiMap_500d_TF-IDF',
            'Exact_Euclidean_None_TF-IDF',
            'Exact_Cosine_None_TF-IDF',
            'Exact_Cosine_scBiMap_500d_TF-IDF',
            'HNSW_Cosine_scBiMap_500d_TF-IDF',
            'PQ_Cosine_scBiMap_500d_TF-IDF',
            'Exact_Euclidean_scBiMap_500d_TF',
            'Exact_Euclidean_None_TF',
            'Exact_Cosine_None_TF',
            'Exact_Cosine_scBiMap_500d_TF',
            'HNSW_Cosine_scBiMap_500d_TF',
            'PQ_Cosine_scBiMap_500d_TF',
        ])

rule mytest3:
    input:
        expand("data/evaluation/human/HLA/ONT_R9/kmer_k16/{method}_overlap_stat.tsv",
        method=[
            'Exact_Euclidean_None_None',
            'Exact_Euclidean_scBiMap_500d_TF-IDF',
            'Exact_Euclidean_None_TF-IDF',
            'Exact_Cosine_None_TF-IDF',
            'Exact_Cosine_scBiMap_500d_TF-IDF',
            'HNSW_Cosine_scBiMap_500d_TF-IDF',
            'PQ_Cosine_scBiMap_500d_TF-IDF',
            'Exact_Euclidean_scBiMap_500d_TF',
            'Exact_Euclidean_None_TF',
            'Exact_Cosine_None_TF',
            'Exact_Cosine_scBiMap_500d_TF',
            'HNSW_Cosine_scBiMap_500d_TF',
            'PQ_Cosine_scBiMap_500d_TF',
            'Minimap2',
            'MinHash_Jaccard_None_None',
        ])

rule mytest4:
    input:
        expand("data/evaluation/human/{region}/ONT_R9/kmer_k16/{method}_overlap_stat.tsv",
        method=[
            'HNSW_Cosine_Spectural_500d_TF-IDF',
            'HNSW_Cosine_Spectural_500d_IDF',
            'HNSW_Cosine_Spectural_500d_None',
            'HNSW_Cosine_Spectural_500d_TF',
            'Exact_Cosine_Spectural_500d_TF-IDF',
            'Exact_Cosine_Spectural_500d_IDF',
            'Exact_Cosine_Spectural_500d_TF',
            'Exact_Cosine_Spectural_500d_None',
        ],region=['IGK','IGH','TRA'])
rule mytest5:
    input:
        expand("data/evaluation/human/chr22/ONT_R9/kmer_k16/{method}_overlap_stat.tsv",
        method=['HNSW_Cosine_Spectural_500d_TF','SimHash_Cosine_None_TF'])
rule mytest7:
    input:
        expand("data/evaluation/human/chr22/ONT_R9/kmer_k16/{method}_overlap_stat.tsv",
        method=['SimHash_Cosine_None_TF'])
rule mytest6:
    input:
        "data/minimap2/human/HLA/ONT_R9/alignment.paf.gz"